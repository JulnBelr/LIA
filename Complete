
#include <Servo.h>
#include <IRremote.h>
// ===== IR CONFIG =====
const int IR_RECEIVE_PIN = 9;
unsigned long lastCode = 0;        // stores last pressed button
unsigned long lastPressTime = 0;   // used to detect button release
const int RELEASE_TIMEOUT = 400;   // ms until stop after release
int mode = 1;                       // default mode
// ===== IR BUTTONS =====
#define BTN_UP      0xB946FF00
#define BTN_LEFT    0xBB44FF00
#define BTN_RIGHT   0xBC43FF00
#define BTN_DOWN    0xEA15FF00
#define BTN_OK      0xBF40FF00    // speed button
#define BTN_MODE1   0xE916FF00    // Mode 1: IR Manual
#define BTN_MODE2   0xE619FF00    // Mode 2: Analog
#define BTN_MODE3   0xF20DFF00    // Mode 3: Ultrasonic
// ===== MOTOR PINS =====
int PWMA = 5, AIN1 = 7;
int PWMB = 6, BIN1 = 8;
int STBY = 3;
// ===== SPEED SYSTEM =====
int y = 100;
const int SPEED_STEP = 5;
const int MAX_SPEED = 255;
const int MIN_SPEED = 0;
// ===== ULTRASONIC =====
Servo myservo;
const int Trig = 13;
const int Echo = 12;
// ===== TIMERS =====
unsigned long ultrasonicTimer = 0;
const unsigned long ULTRASONIC_INTERVAL = 50;  // ms between distance checks
void setup() {
  Serial.begin(9600);
  IrReceiver.begin(IR_RECEIVE_PIN, ENABLE_LED_FEEDBACK);
  // Motor pins
  pinMode(PWMA, OUTPUT); pinMode(AIN1, OUTPUT);
  pinMode(PWMB, OUTPUT); pinMode(BIN1, OUTPUT);
  pinMode(STBY, OUTPUT); digitalWrite(STBY, HIGH);
  // Ultrasonic
  pinMode(Trig, OUTPUT); pinMode(Echo, INPUT);
  myservo.attach(10);
  Serial.println("System Booted â€” Ready");
}
void loop() {
  // ==== IR READ (only once per loop) ====
  if (IrReceiver.decode()) {
    unsigned long code = IrReceiver.decodedIRData.decodedRawData;
    if (code != 0x0) lastCode = code;  // store valid code
    lastPressTime = millis();           // reset hold timer
    // MODE SWITCHING
    if (lastCode == BTN_MODE1) { mode = 1; Serial.println("MODE 1: IR Drive"); }
    if (lastCode == BTN_MODE2) { mode = 2; Serial.println("MODE 2: Analog Auto"); }
    if (lastCode == BTN_MODE3) { mode = 3; Serial.println("MODE 3: Ultrasonic Avoid"); }
    IrReceiver.resume();
  }
  // ===== EXECUTE CURRENT MODE =====
  switch(mode){
    case 1: modeIRControl(); break;
    case 2: modeAnalogSensor(); break;
    case 3: modeUltrasonic(); break;
  }
}
///////////////////////////////////////////////////////////////
//==================== MODE 1 : HOLD TO MOVE =================//
///////////////////////////////////////////////////////////////
void modeIRControl() {
  // SPEED BUTTON
  if (lastCode == BTN_OK){
    y += SPEED_STEP;
    if(y > MAX_SPEED) y = MIN_SPEED;
    Serial.print("Speed = "); Serial.println(y);
    lastCode = 0; // prevent repeated increments
  }
  // Stop motors if no button pressed
  if (millis() - lastPressTime > RELEASE_TIMEOUT){
    stopMotors();
    return;
  }
  // Hold-to-move logic
  switch(lastCode){
    case BTN_UP:      forward(y); break;
    case BTN_DOWN:    backward(y); break;
    case BTN_LEFT:    left(y); break;
    case BTN_RIGHT:   right(y); break;
    default:          stopMotors(); break;
  }
}
///////////////////////////////////////////////////////////////
//==================== MODE 2 : ANALOG SENSOR =================//
///////////////////////////////////////////////////////////////
void modeAnalogSensor() {
  float R = analogRead(A0);
  float M = analogRead(A1);
  float L = analogRead(A2);
  if (M > 1000) { stopMotors(); return; }
  if (L > 300) { left(50); return; }
  if (M > 300) { forward(50); return; }
  if (R > 300) { right(50); return; }
  else { right(50); } // idle drift
}
///////////////////////////////////////////////////////////////
//==================== MODE 3 : ULTRASONIC ====================//
///////////////////////////////////////////////////////////////
void modeUltrasonic() {
  if (millis() - ultrasonicTimer < ULTRASONIC_INTERVAL) return; // non-blocking delay
  ultrasonicTimer = millis();
  myservo.write(90);
  float front = DistanceMeter();
  if (front == 0 || front >= 25) { forward(70); return; }
  stopMotors();
  // Check left
  myservo.write(150);
  delay(500); // small servo settle time
  float leftD = DistanceMeter(); if (leftD == 0) leftD = 300;
  if (leftD > 25) { left(70); return; }
  // Check right
  myservo.write(30);
  delay(500);
  float rightD = DistanceMeter(); if (rightD == 0) rightD = 300;
  if (rightD < 25) { backward(70); delay(600); left(70); delay(1000); forward(70); return; }
  right(70);
}
///////////////////////////////////////////////////////////////
//========================= FUNCTIONS =========================//
///////////////////////////////////////////////////////////////
float DistanceMeter() {
  digitalWrite(Trig, LOW); delayMicroseconds(2);
  digitalWrite(Trig, HIGH); delayMicroseconds(10);
  digitalWrite(Trig, LOW);
  long d = pulseIn(Echo, HIGH, 25000);
  if (!d) return 0;
  float cm = (d * 0.0343) / 2;
  return (cm > 300) ? 0 : cm;
}
void forward(int s){ digitalWrite(AIN1,HIGH); analogWrite(PWMA,s); digitalWrite(BIN1,HIGH); analogWrite(PWMB,s); }
void backward(int s){ digitalWrite(AIN1,LOW); analogWrite(PWMA,s); digitalWrite(BIN1,LOW); analogWrite(PWMB,s); }
void left(int s){ digitalWrite(AIN1,HIGH); analogWrite(PWMA,s); digitalWrite(BIN1,LOW); analogWrite(PWMB,s); }
void right(int s){ digitalWrite(AIN1,LOW); analogWrite(PWMA,s); digitalWrite(BIN1,HIGH); analogWrite(PWMB,s); }
void stopMotors(){ analogWrite(PWMA,0); analogWrite(PWMB,0); }
